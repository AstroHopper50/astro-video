<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroStar - Starless Transition Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #020617; }
        .glass-card { 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top-color: #60a5fa;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-200 min-h-screen flex flex-col items-center justify-center p-6">

    <!-- Background Glows -->
    <div class="fixed inset-0 overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-600/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-indigo-600/10 rounded-full blur-[120px]"></div>
    </div>

    <div class="max-w-xl w-full glass-card p-8 rounded-[2rem] shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 shimmer"></div>
        
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold tracking-tight bg-gradient-to-br from-white to-slate-400 bg-clip-text text-transparent">AstroStar</h1>
            <p class="text-slate-400 text-sm mt-2">Generate AI Star-to-Starless transitions</p>
        </header>

        <div class="space-y-6">
            <div>
                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-500 mb-2 ml-1">Nebula or Galaxy Prompt</label>
                <input id="promptInput" type="text" 
                       placeholder="e.g. The Pillars of Creation in deep blue..."
                       class="w-full bg-slate-900/50 border border-slate-800 rounded-2xl px-5 py-4 focus:outline-none focus:ring-2 focus:ring-blue-500/40 transition-all placeholder:text-slate-600">
            </div>

            <button id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-500 disabled:bg-slate-800 disabled:text-slate-500 text-white font-semibold py-4 rounded-2xl transition-all flex items-center justify-center gap-3 group">
                <span id="btnText">Create Video</span>
                <svg id="btnIcon" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 group-hover:translate-x-1 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
            </button>
        </div>

        <!-- Progress Indicator -->
        <div id="statusArea" class="mt-10 hidden">
            <div class="flex justify-between items-end mb-2">
                <span id="statusText" class="text-xs font-medium text-blue-400">Initializing...</span>
                <span id="progressPercent" class="text-[10px] text-slate-500">0%</span>
            </div>
            <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div>
            </div>
        </div>

        <!-- Result Area -->
        <div id="resultArea" class="mt-10 hidden">
            <div class="rounded-2xl overflow-hidden border border-slate-800 bg-black aspect-square mb-6">
                <video id="outputVideo" controls class="w-full h-full"></video>
            </div>
            <div class="flex gap-3">
                <button id="downloadBtn" class="flex-1 bg-white text-black font-bold py-3 rounded-xl hover:bg-slate-200 transition-colors">
                    Download MP4
                </button>
                <button onclick="window.location.reload()" class="px-4 py-3 bg-slate-800 rounded-xl hover:bg-slate-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                </button>
            </div>
        </div>
    </div>

    <footer class="mt-10 text-slate-600 text-[10px] uppercase tracking-[0.3em] font-medium">
        Deep Space AI Imaging
    </footer>

    <script>
        const apiKey = ""; // Managed by environment
        
        const generateBtn = document.getElementById('generateBtn');
        const promptInput = document.getElementById('promptInput');
        const statusArea = document.getElementById('statusArea');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const resultArea = document.getElementById('resultArea');
        const outputVideo = document.getElementById('outputVideo');
        const downloadBtn = document.getElementById('downloadBtn');

        async function fetchImage(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
            const payload = {
                instances: [{ prompt }],
                parameters: { sampleCount: 1 }
            };

            let retryCount = 0;
            const maxRetries = 5;
            
            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        const data = await response.json();
                        return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                    }
                } catch (e) {}
                const delay = Math.pow(2, retryCount) * 1000;
                await new Promise(r => setTimeout(r, delay));
                retryCount++;
            }
            throw new Error("API failed after retries.");
        }

        function setProgress(text, pct) {
            statusText.innerText = text;
            progressBar.style.width = `${pct}%`;
            progressPercent.innerText = `${pct}%`;
        }

        async function startGeneration() {
            const userPrompt = promptInput.value.trim() || "Deep space nebula with vibrant colorful dust clouds";
            
            try {
                generateBtn.disabled = true;
                statusArea.classList.remove('hidden');
                resultArea.classList.add('hidden');
                
                // Phase 1: Starry Image
                setProgress("Generating Star Field...", 20);
                const starPrompt = `${userPrompt}, 8k astrophotography, pinpoint stars, realistic space photography, sharp focus`;
                const imgStarSrc = await fetchImage(starPrompt);

                // Phase 2: Starless Image
                setProgress("Removing Stars with AI...", 50);
                const starlessPrompt = `${userPrompt}, starless nebula, no stars, pure cosmic dust clouds, smooth texture, professional star removal`;
                const imgStarlessSrc = await fetchImage(starlessPrompt);

                // Phase 3: Video Assembly
                setProgress("Synthesizing Transition...", 80);
                
                const canvas = document.createElement('canvas');
                canvas.width = 1024;
                canvas.height = 1024;
                const ctx = canvas.getContext('2d');

                const loadImg = (src) => new Promise(res => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => res(img);
                    img.src = src;
                });

                const imgStar = await loadImg(imgStarSrc);
                const imgStarless = await loadImg(imgStarlessSrc);

                const stream = canvas.captureStream(30);
                const recorder = new MediaRecorder(stream, { 
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 8000000 
                });
                
                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/mp4' });
                    const url = URL.createObjectURL(blob);
                    outputVideo.src = url;
                    downloadBtn.onclick = () => {
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `astro_transition_${Date.now()}.mp4`;
                        a.click();
                    };
                    
                    setProgress("Complete!", 100);
                    setTimeout(() => {
                        statusArea.classList.add('hidden');
                        resultArea.classList.remove('hidden');
                        generateBtn.disabled = false;
                    }, 500);
                };

                recorder.start();

                // 6 Second Animation Sequence
                const fps = 30;
                const totalFrames = 6 * fps;
                let frame = 0;

                function animate() {
                    if (frame >= totalFrames) {
                        recorder.stop();
                        return;
                    }

                    ctx.clearRect(0, 0, 1024, 1024);
                    const progress = frame / totalFrames; // 0 to 1
                    let opacity = 0;

                    // Timeline: 
                    // 0-1.5s: Just stars
                    // 1.5s-3s: Fade in starless
                    // 3s-4.5s: Just starless
                    // 4.5s-6s: Fade back to stars
                    
                    if (progress < 0.25) {
                        opacity = 0;
                    } else if (progress < 0.5) {
                        opacity = (progress - 0.25) / 0.25;
                    } else if (progress < 0.75) {
                        opacity = 1;
                    } else {
                        opacity = 1 - ((progress - 0.75) / 0.25);
                    }

                    ctx.drawImage(imgStar, 0, 0, 1024, 1024);
                    ctx.globalAlpha = opacity;
                    ctx.drawImage(imgStarless, 0, 0, 1024, 1024);
                    ctx.globalAlpha = 1.0;

                    frame++;
                    requestAnimationFrame(animate);
                }

                animate();

            } catch (err) {
                console.error(err);
                statusText.innerText = "Error: " + err.message;
                generateBtn.disabled = false;
            }
        }

        generateBtn.addEventListener('click', startGeneration);
    </script>
</body>
</html>
